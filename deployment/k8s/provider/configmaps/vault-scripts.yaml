apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-scripts
  namespace: rainbow-provider
data:
  secrets-gen.sh: |
    #!/bin/sh
    set -e

    SECRETS_DIR=$1
    ROLE=$2

    if [ -z "$ROLE" ]; then
        echo "Usage: $0 <secrets_dir> <role>"
        echo "Role must be 'provider'"
        exit 1
    fi

    mkdir -p "$SECRETS_DIR"

    if [ ! -f "$SECRETS_DIR/private_key.pem" ]; then
        echo "Generating private_key.pem..."
        openssl genrsa -out "$SECRETS_DIR/private_key.pem" 2048
    else
        echo "private_key.pem already exists. Skipping."
    fi

    if [ ! -f "$SECRETS_DIR/public_key.pem" ]; then
        echo "Generating public_key.pem..."
        openssl rsa -in "$SECRETS_DIR/private_key.pem" -pubout -out "$SECRETS_DIR/public_key.pem"
    else
        echo "public_key.pem already exists. Skipping."
    fi

    if [ ! -f "$SECRETS_DIR/cert.pem" ]; then
        echo "Generating cert.pem..."
        openssl req -new -x509 -key "$SECRETS_DIR/private_key.pem" -out "$SECRETS_DIR/cert.pem" -days 365 -subj "/C=ES/ST=Madrid/L=Madrid/O=Eunomia/CN=localhost"
    else
        echo "cert.pem already exists. Skipping."
    fi

    if [ ! -f "$SECRETS_DIR/db.json" ]; then
        echo "Generating db.json for $ROLE..."
        echo '{
      "user": "ds_provider",
      "password": "ds_provider",
      "name": "ds_provider"
    }' > "$SECRETS_DIR/db.json"
    else
        echo "db.json already exists. Skipping."
    fi

    if [ ! -f "$SECRETS_DIR/wallet.json" ]; then
        echo "Generating wallet.json for $ROLE..."
        echo '{
      "type": "email",
      "name": "provider",
      "email": "provider@rainbow.dev",
      "password": "provider"
    }' > "$SECRETS_DIR/wallet.json"
    else
        echo "wallet.json already exists. Skipping."
    fi

    echo "Secrets generation complete in $SECRETS_DIR for $ROLE"

  vault-init.sh: |
    #!/bin/sh
    set -e

    if [ -z "$VAULT_ADDR" ]; then
        echo "[ERROR] VAULT_ADDR not set. Exiting."
        exit 1
    fi

    VAULT_DATA_DIR=${VAULT_DATA_DIR:-/vault/data}
    KEYS_FILE="$VAULT_DATA_DIR/keys.json"
    ENV_OUTPUT_FILE="$VAULT_DATA_DIR/vault.env"

    echo "[INIT] Vault Address: $VAULT_ADDR"

    # Health Check
    echo "[INIT] Waiting for Vault to respond..."
    MAX_RETRIES=30
    COUNT=0

    while ! curl -s "$VAULT_ADDR/v1/sys/health" > /dev/null; do
        COUNT=$((COUNT+1))
        if [ "$COUNT" -ge "$MAX_RETRIES" ]; then
            echo "[ERROR] Timeout waiting for Vault at $VAULT_ADDR"
            exit 1
        fi
        sleep 2
    done
    echo "[INIT] Vault is reachable."

    # Initialization
    if [ ! -f "$KEYS_FILE" ]; then
        echo "[INFO] Initializing Vault..."
        vault operator init -key-shares=1 -key-threshold=1 -format=json > "$KEYS_FILE"
        echo "[INFO] Initialization complete."
    else
        echo "[INFO] Keys file found. Skipping initialization."
    fi

    # Unseal
    SEALED_STATUS=$(vault status -format=json | jq -r ".sealed")

    if [ "$SEALED_STATUS" = "true" ]; then
        echo "[INFO] Unsealing Vault..."
        UNSEAL_KEY=$(jq -r ".unseal_keys_b64[0]" "$KEYS_FILE")

        if [ -z "$UNSEAL_KEY" ] || [ "$UNSEAL_KEY" = "null" ]; then
            echo "[ERROR] Could not retrieve unseal key from $KEYS_FILE."
            exit 1
        fi

        vault operator unseal "$UNSEAL_KEY" > /dev/null
        echo "[INFO] Vault unsealed successfully."
    else
        echo "[INFO] Vault is already unsealed."
    fi

    # Generate Environment File
    echo "[INFO] Generating .env file..."
    ROOT_TOKEN=$(jq -r ".root_token" "$KEYS_FILE")

    cat <<EOF > "$ENV_OUTPUT_FILE"
    # Generated by Vault Auto-Init
    VAULT_ADDR=$VAULT_ADDR
    VAULT_TOKEN=$ROOT_TOKEN
    VAULT_SKIP_VERIFY=true
    VAULT_MOUNT=rainbow
    EOF

    echo "[SUCCESS] Environment file generated at: $ENV_OUTPUT_FILE"
