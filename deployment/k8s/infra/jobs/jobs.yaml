# Infra Vault Setup Job
---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-setup
  namespace: rainbow-infra
  labels:
    app: vault-setup
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: vault-setup
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-vault
          image: busybox:1.36
          resources:
            requests:
              memory: "32Mi"
              cpu: "25m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          command:
            - sh
            - -c
            - |
              echo "Waiting for Authority Vault..."
              until wget -q --spider http://authority-vault:8200/v1/sys/health; do
                echo "Waiting for authority-vault..."
                sleep 2
              done
              echo "Authority Vault is ready!"

      containers:
        - name: init-vault
          image: hashicorp/vault:1.21
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
          env:
            - name: VAULT_ADDR
              value: "http://authority-vault:8200"
          command:
            - sh
            - -c
            - |
              set -e
              KEYS_FILE="/vault-data/keys.json"

              if vault status -format=json 2>/dev/null | grep -q '"initialized":true'; then
                echo "Authority Vault already initialized"
                
                if vault status -format=json | grep -q '"sealed":true'; then
                  echo "Unsealing Authority Vault..."
                  if [ -f "$KEYS_FILE" ]; then
                    UNSEAL_KEY=$(cat "$KEYS_FILE" | jq -r ".unseal_keys_b64[0]")
                    vault operator unseal "$UNSEAL_KEY"
                  fi
                fi
              else
                echo "Initializing Authority Vault..."
                vault operator init -key-shares=1 -key-threshold=1 -format=json > "$KEYS_FILE"
                UNSEAL_KEY=$(cat "$KEYS_FILE" | jq -r ".unseal_keys_b64[0]")
                vault operator unseal "$UNSEAL_KEY"
              fi

              # Create k8s secret with token for Heimdall
              ROOT_TOKEN=$(cat "$KEYS_FILE" | jq -r ".root_token")
              echo "Authority Vault Token: $ROOT_TOKEN"
          volumeMounts:
            - name: vault-data
              mountPath: /vault-data

      volumes:
        - name: vault-data
          persistentVolumeClaim:
            claimName: authority-vault-pvc

---
# Infra Secrets Generation Job
apiVersion: batch/v1
kind: Job
metadata:
  name: secrets-gen
  namespace: rainbow-infra
  labels:
    app: secrets-gen
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: secrets-gen
    spec:
      restartPolicy: OnFailure
      containers:
        - name: authority-secrets
          image: alpine:latest
          resources:
            requests:
              memory: "32Mi"
              cpu: "25m"
            limits:
              memory: "64Mi"
              cpu: "100m"
          command:
            - sh
            - -c
            - |
              apk add --no-cache openssl
              /scripts/secrets-gen.sh /secrets authority
          volumeMounts:
            - name: vault-scripts
              mountPath: /scripts
            - name: secrets
              mountPath: /secrets

      volumes:
        - name: vault-scripts
          configMap:
            name: vault-scripts
            defaultMode: 0755
        - name: secrets
          persistentVolumeClaim:
            claimName: authority-secrets-pvc

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: authority-secrets-pvc
  namespace: rainbow-infra
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 64Mi
