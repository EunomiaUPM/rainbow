import{j as e,a3 as F,a4 as V,r as l,b as q}from"./ui-B_Y8HlyQ.js";import{a as P,I as B,B as Y,v as G,G as v,w as L,x as $,y as M,z as Q,A as U,C as H,E as J}from"./index-2IBXBLVr.js";import{H as A}from"./heading-Dyo69VqW.js";import{I as W}from"./info-list-CzLp-cMe.js";import{A as Z,a as K,b as X,c as ee,S as E,d as I,e as _,f as R,o as te,g as S,l as ie,h as ae}from"./index-BfmDa8Jz.js";import{a as O,B as p,b as ne,c as T}from"./infoItemMappers-CT53hr-5.js";import{P as oe,N as re}from"./ProcessActionDialog-Ac7-MRvm.js";const se={permission:{accordionItem:"bg-success-500/10 border border-success-600/20",trigger:"bg-success-400/25",removeIcon:"text-foreground"},obligation:{accordionItem:"bg-warn-500/10 border border-warn-600/20",trigger:"bg-warn-400/25",removeIcon:"text-danger"},prohibition:{accordionItem:"bg-danger-500/10 border border-danger-600/20",trigger:"bg-danger-500/25",removeIcon:"text-foreground"}},D=({type:t,items:i,onAdd:r,onRemove:s,onActionChange:c,onAddConstraint:d,onRemoveConstraint:x,onOperandChange:u})=>{const m=se[t];return e.jsx(Z,{type:"single",collapsible:!0,className:"w-full",children:e.jsxs(K,{value:"item-1",className:m.accordionItem,children:[e.jsx(X,{className:`text-white/70 flex ${m.trigger} uppercase overflow-hidden rounded-md data-[state=open]:rounded-b-none`,children:e.jsx("div",{className:"flex items-center w-full",children:e.jsx("p",{className:"text-current",children:t})})}),e.jsxs(ee,{className:"relative",children:[e.jsxs(P,{className:"border-b border-white/15",variant:"outline",size:"xs",onClick:()=>r(t),children:[e.jsx(F,{}),"Add ",t]}),i.map((h,b)=>{var N;return e.jsx("div",{children:e.jsxs("div",{className:"policy-item-create",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{className:"mb-2",children:"Action:"}),e.jsxs(P,{variant:"icon_destructive",size:"xs",className:"ml-4 border",onClick:()=>s(t,b),children:[e.jsx(V,{className:`mb-0.5 ${m.removeIcon}`}),"Remove ",t]})]}),e.jsxs(E,{onValueChange:a=>c(t,b,a),value:h.action,children:[e.jsx(I,{className:"w-[240px]",children:e.jsx(_,{placeholder:"Select action"})}),e.jsx(R,{children:te.map(a=>e.jsx(S,{value:a,children:a},a))})]}),e.jsx("div",{className:"h-6"}),e.jsx("p",{className:"mb-2",children:"Constraints:"}),(N=h.constraint)==null?void 0:N.map((a,o)=>e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("div",{className:"constraint-create flex gap-3 items-end",children:[e.jsx(E,{onValueChange:n=>u(t,b,o,"leftOperand",n),value:a.leftOperand,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("p",{className:"text-xs text-gray-400 mb-1",children:"Left Operand:"}),e.jsx(I,{className:"w-[180px]",children:e.jsx(_,{placeholder:"Select item"})}),e.jsx(R,{children:ie.map(n=>e.jsx(S,{value:n,children:n},n))})]})}),e.jsx(E,{onValueChange:n=>u(t,b,o,"operator",n),value:a.operator,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("p",{className:"text-xs text-gray-400 mb-1",children:"Operator:"}),e.jsx(I,{className:"w-[140px]",children:e.jsx(_,{placeholder:"Select operator"})}),e.jsx(R,{children:ae.map(n=>e.jsx(S,{value:n,children:n},n))})]})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("p",{className:"text-xs text-gray-400 mb-1",children:"Right Operand:"}),e.jsx(B,{placeholder:"Type value",value:a.rightOperand,onChange:n=>u(t,b,o,"rightOperand",n.currentTarget.value)})]}),e.jsx("div",{children:e.jsx(P,{variant:"icon_destructive",size:"icon",onClick:()=>x(t,b,o),children:e.jsx(V,{className:"mb-0.5"})})})]})},o)),e.jsxs(P,{size:"xs",variant:"outline",className:"mt-3",onClick:()=>d(t,b),children:[e.jsx(F,{}),"Add constraint"]})]})},`${t}-${b}-${h.action||"new"}`)})]})]})})},z=({policy:t,onChange:i})=>{var N;const[r,s]=l.useState({obligation:[],permission:[],prohibition:[]});l.useEffect(()=>{const a={obligation:t.obligation||[],permission:t.permission||[],prohibition:t.prohibition||[]};s(a),i==null||i(a)},[t]);const c=l.useCallback(a=>{s(o=>{const n=a(o);return i==null||i(n),n})},[i]),d=l.useCallback(a=>{const o={action:"",constraint:[]};c(n=>({...n,[a]:[...n[a],o]}))},[c]),x=l.useCallback((a,o)=>{c(n=>({...n,[a]:n[a].filter((f,g)=>g!==o)}))},[c]),u=l.useCallback((a,o)=>{c(n=>{const f=[...n[a]];return f[o]={...f[o],constraint:[...f[o].constraint,{leftOperand:"",operator:"",rightOperand:""}]},{...n,[a]:f}})},[c]),m=l.useCallback((a,o,n)=>{c(f=>{const g=[...f[a]];return g[o]={...g[o],constraint:g[o].constraint.filter((y,C)=>C!==n)},{...f,[a]:g}})},[c]),h=l.useCallback((a,o,n)=>{c(f=>{const g=[...f[a]];return g[o]={...g[o],action:n},{...f,[a]:g}})},[c]),b=l.useCallback((a,o,n,f,g)=>{c(y=>{const C=[...y[a]],w=[...C[o].constraint];return w[n]={...w[n],[f]:g},C[o]={...C[o],constraint:w},{...y,[a]:C}})},[c]);return e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"border border-white/30 bg-white/10 p-3 pt-2 rounded-md justify-start",children:[e.jsx("div",{className:"flex mb-4",children:e.jsxs(A,{level:"h5",className:"flex gap-3",children:[e.jsx("div",{children:"Policy with ID"}),e.jsx(Y,{variant:"info",className:"h-6",children:t["@id"].slice(9,29)+"[...]"})]})}),e.jsx(W,{items:[{label:"Policy Target",value:t["@type"]},{label:"Profile",value:JSON.stringify(t.profile)},{label:"Target",value:(N=t.target)==null?void 0:N.slice(9)}]}),e.jsx("div",{className:"h-5"}),e.jsx(A,{level:"h6",children:"ODRL CONTENT"}),e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(D,{type:"permission",items:r.permission,onAdd:d,onRemove:x,onActionChange:h,onAddConstraint:u,onRemoveConstraint:m,onOperandChange:b}),e.jsx(D,{type:"obligation",items:r.obligation,onAdd:d,onRemove:x,onActionChange:h,onAddConstraint:u,onRemoveConstraint:m,onOperandChange:b}),e.jsx(D,{type:"prohibition",items:r.prohibition,onAdd:d,onRemove:x,onActionChange:h,onAddConstraint:u,onRemoveConstraint:m,onOperandChange:b})]})})]})})},ce=({process:t})=>{const[i,r]=l.useState(null),{mutateAsync:s}=G(),{api_gateway:c}=l.useContext(v),{data:d}=L(t.provider_id),x=O(t),u=async()=>{if(i&&d){const h={...d.offer_content,prohibition:i.prohibition&&i.prohibition.length>0?i.prohibition:void 0,permission:i.permission&&i.permission.length>0?i.permission:void 0,obligation:i.obligation&&i.obligation.length>0?i.obligation:void 0};await s({api_gateway:c,content:{consumerParticipantId:t.associated_consumer,offer:h,consumerPid:t.consumer_id,providerPid:t.provider_id}})}},m=d?e.jsxs("div",{className:"pt-4",children:[e.jsx(A,{level:"h6",className:"mb-2",children:"Counter Offer Policy"}),e.jsx(z,{policy:d.offer_content,onChange:r})]}):null;return e.jsx(p,{title:"Contract Negotiation Offer",description:"Make changes to the Contract Negotiation Offer and submit a counter-offer.",infoItems:x,afterInfoContent:m,submitLabel:"Counter Offer",submitVariant:"outline",onSubmit:u,scrollable:!0})},k=({process:t})=>{const{api_gateway:i}=l.useContext(v),{mutateAsync:r}=$(),s=async()=>{await r({api_gateway:i,content:{consumerParticipantId:t.associated_consumer,consumerPid:t.consumer_id,providerPid:t.provider_id}})};return e.jsx(p,{title:"Agreement Dialog",description:e.jsxs(e.Fragment,{children:["You are about to agree to the terms of the contract negotiation.",e.jsx("br",{}),"Please review the details carefully before proceeding."]}),infoItems:O(t),submitLabel:"Agree",submitVariant:"default",onSubmit:s})},j=({process:t})=>{const{api_gateway:i,dsrole:r}=l.useContext(v),{mutateAsync:s}=M(),c=async()=>{r==="consumer"?await s({api_gateway:i,content:{providerParticipantId:t.associated_provider,consumerPid:t.consumer_id,providerPid:t.provider_id}}):r==="provider"&&await s({api_gateway:i,content:{consumerParticipantId:t.associated_consumer,consumerPid:t.consumer_id,providerPid:t.provider_id}})};return e.jsx(p,{title:"Termination Dialog",description:e.jsxs(e.Fragment,{children:["You are about to terminate the contract negotiation.",e.jsx("br",{}),"Please review the details carefully before proceeding."]}),infoItems:ne(t),submitLabel:"Terminate",submitVariant:"destructive",onSubmit:c})},le=({process:t})=>{const{api_gateway:i}=l.useContext(v),{mutateAsync:r}=Q(),s=async()=>{await r({api_gateway:i,content:{consumerParticipantId:t.associated_consumer,consumerPid:t.consumer_id,providerPid:t.provider_id}})};return e.jsx(p,{title:"Finalization Dialog",description:e.jsxs(e.Fragment,{children:["You are about to finalize the contract negotiation.",e.jsx("br",{}),"Please review the details carefully before proceeding."]}),infoItems:O(t),submitLabel:"Finalize",submitVariant:"default",onSubmit:s})},de=({process:t})=>{const[i,r]=l.useState(null),{mutateAsync:s}=U(),{api_gateway:c}=l.useContext(v),{data:d}=L(t.consumer_id),x=T(t),u=async()=>{if(i&&d){const h={...d.offer_content,prohibition:i.prohibition&&i.prohibition.length>0?i.prohibition:void 0,permission:i.permission&&i.permission.length>0?i.permission:void 0,obligation:i.obligation&&i.obligation.length>0?i.obligation:void 0};await s({api_gateway:c,content:{providerParticipantId:t.associated_provider,offer:h,consumerPid:t.consumer_id,providerPid:t.provider_id}})}},m=d?e.jsxs("div",{className:"pt-4",children:[e.jsx(A,{level:"h6",className:"mb-2",children:"New Policy Request"}),e.jsx(z,{policy:d.offer_content,onChange:r})]}):null;return e.jsx(p,{title:"Contract Negotiation Request",description:"Make changes to the Contract Negotiation Request and submit a counter-request.",infoItems:x,afterInfoContent:m,submitLabel:"Request",submitVariant:"outline",onSubmit:u,scrollable:!0})},ue=({process:t})=>{const{api_gateway:i}=l.useContext(v),{mutateAsync:r}=H(),s=async()=>{await r({api_gateway:i,content:{providerParticipantId:t.associated_provider,consumerPid:t.consumer_id,providerPid:t.provider_id}})};return e.jsx(p,{title:"Acceptance Dialog",description:e.jsxs(e.Fragment,{children:["You are about to accept the contract offer.",e.jsx("br",{}),"Please review the details carefully before proceeding."]}),infoItems:T(t),submitLabel:"Accept",submitVariant:"default",onSubmit:s})},me=({process:t})=>{const{api_gateway:i}=l.useContext(v),{mutateAsync:r}=J(),s=async()=>{await r({api_gateway:i,content:{providerParticipantId:t.associated_provider,consumerPid:t.consumer_id,providerPid:t.provider_id}})};return e.jsx(p,{title:"Verification Dialog",description:e.jsxs(e.Fragment,{children:["You are about to verify the agreement.",e.jsx("br",{}),"Please review the details carefully before proceeding."]}),infoItems:T(t),submitLabel:"Verify",submitVariant:"default",onSubmit:s})},Ce=({process:t,tiny:i=!1})=>{const{dsrole:r}=l.useContext(v),s=q("",{variants:{tiny:{true:"inline-flex items-center ",false:" w-full p-6 fixed bottom-0 left-0 md:left-[223px] bg-background/80 backdrop-blur-sm border border-t-stroke [&>*>button]:min-w-20"}}}),d=(()=>{if(r==="provider")switch(t.state){case"REQUESTED":return[{label:"Terminate",variant:"destructive",Component:j},{label:"Counter offer",variant:"outline",Component:ce},{label:"Agree",variant:"default",Component:k}];case"OFFERED":return[{label:"Terminate",variant:"destructive",Component:j}];case"ACCEPTED":return[{label:"Agree",variant:"default",Component:k}];case"AGREED":return[{label:"Terminate",variant:"destructive",Component:j}];case"VERIFIED":return[{label:"Finalize",variant:"default",Component:le},{label:"Terminate",variant:"destructive",Component:j}];default:return[]}else if(r==="consumer")switch(t.state){case"REQUESTED":return[{label:"Terminate",variant:"destructive",Component:j}];case"OFFERED":return[{label:"Accept",variant:"default",Component:ue},{label:"Counter request",variant:"outline",Component:de},{label:"Terminate",variant:"destructive",Component:j}];case"AGREED":return[{label:"Verify",variant:"default",Component:me}];default:return[]}return[]})(),x=()=>t.state==="FINALIZED"||t.state==="TERMINATED"||r==="consumer"&&(t.state==="ACCEPTED"||t.state==="VERIFIED");return e.jsx("div",{className:s({tiny:i}),children:e.jsxs("div",{className:t.state==="OFFERED"||t.state==="ACCEPTED"||t.state==="VERIFIED"?"flex justify-end flex-row-reverse gap-2":t.state==="REQUESTED"?"space-x-2 min-w-[260px]":"flex justify-start gap-2",children:[d.map((u,m)=>e.jsx(oe,{label:u.label,variant:u.variant,tiny:i,DialogComponent:u.Component,process:t},m)),x()&&e.jsx(re,{})]})})};export{Ce as C};
